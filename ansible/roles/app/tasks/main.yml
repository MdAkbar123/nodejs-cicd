- name: Deploy Node.js Application
  block:
    - name: Ensure app directory exists
      ansible.builtin.file:
        path: "{{ app_dir }}"
        state: directory
        owner: ubuntu
        mode: "0755"

    - name: Clone repository into node-service
      ansible.builtin.git:  # Fixed: Use FQCN
        repo: "{{ app_repo_url }}"
        dest: "{{ app_dir }}"
        version: main
        force: true
      become: true          # Fixed: Added corresponding become
      become_user: ubuntu

    - name: Debug cloned directory
      ansible.builtin.command: "ls -l {{ app_dir }}/app"
      register: list_output
      ignore_errors: true
      changed_when: false   # Fixed: "Commands should not change things"

    - name: Show directory contents
      ansible.builtin.debug: # Fixed: Use FQCN
        var: list_output.stdout_lines

    - name: Install Node.js dependencies
      community.general.npm: # Fixed: Use FQCN (requires community.general collection)
        path: "{{ app_dir }}/app"
        production: true
      become: true          # Fixed: Added corresponding become
      become_user: ubuntu

    - name: Stop existing Node.js process
      ansible.builtin.shell: pkill node || true
      ignore_errors: true
      changed_when: false   # Fixed: "Commands should not change things"

    - name: Create systemd service file
      ansible.builtin.copy: # Fixed: Use FQCN
        dest: "/etc/systemd/system/{{ app_service_name }}.service"
        mode: "0644"        # Fixed: Explicit permissions required
        content: |
          [Unit]
          Description=Node.js Application
          After=network.target

          [Service]
          WorkingDirectory={{ app_dir }}/app
          ExecStart={{ app_start_command }}
          Restart=always
          User=ubuntu
          Environment=PORT={{ app_node_port }}
          StandardOutput=append:/var/log/node-service.log
          StandardError=append:/var/log/node-service-error.log

          [Install]
          WantedBy=multi-user.target
      notify: Restart Node app

    - name: Reload systemd
      ansible.builtin.systemd: # Fixed: Use FQCN
        daemon_reload: true

    - name: Enable and start service
      ansible.builtin.systemd: # Fixed: Use FQCN
        name: "{{ app_service_name }}"
        enabled: true
        state: started

  rescue:
    - name: Debug failure
      ansible.builtin.debug:
        msg: "Deployment failed â€” check logs."

  always:
    - name: Debug lifecycle end
      ansible.builtin.debug:
        msg: "Deployment lifecycle finished."